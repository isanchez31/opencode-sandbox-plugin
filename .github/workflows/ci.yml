name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - run: bun run check

      - run: bun run typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Run tests with coverage
        run: |
          bun test --coverage 2>&1 | tee /tmp/coverage.txt

      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep 'All files' /tmp/coverage.txt | awk -F'|' '{gsub(/ /, "", $3); print $3}')
          echo "Line coverage: ${COVERAGE}%"
          THRESHOLD=85
          if [ "$(echo "$COVERAGE < $THRESHOLD" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

      - run: bun run build
